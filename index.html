<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FWorkout+</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #000;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animasi untuk modal dan halaman */
        .view-enter { opacity: 0; transform: translateY(20px); }
        .view-enter-active { opacity: 1; transform: translateY(0); transition: all 300ms ease-out; }
        .view-leave-active { opacity: 0; transform: translateY(-20px); transition: all 300ms ease-in; }

        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 300ms ease-out; }
        .modal-leave-active { opacity: 0; transform: scale(0.95); transition: all 200ms ease-in; }

        .snapshot-container { aspect-ratio: 9 / 16; width: 100%; max-width: 400px; }
        
        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 0.5s cubic-bezier(0.21, 1.02, 0.73, 1); }
        .toast-leave-active { transform: translateY(100%); opacity: 0; transition: all 0.5s cubic-bezier(0.25, 0, 0.5, 1); }

        .bottom-nav {
            padding-bottom: var(--safe-area-inset-bottom);
            transform: translateX(-50%);
            transition: transform 0.3s ease-in-out;
        }
        .bottom-nav.nav-hidden {
            transform: translateX(-50%) translateY(100%);
        }
        .main-content-padding {
             padding-bottom: calc(80px + var(--safe-area-inset-bottom));
        }
    </style>
</head>
<body class="bg-black text-white antialiased">

    <!-- Kontainer Utama Aplikasi -->
    <div id="app-container" class="max-w-lg mx-auto h-screen bg-black flex flex-col">

        <!-- Halaman Utama (For You) -->
        <div id="main-view" class="flex flex-col flex-grow overflow-hidden">
            <header class="p-4 pt-6 flex-shrink-0">
                <div class="flex items-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                    <h1 class="text-3xl font-bold tracking-tight">FWorkout+</h1>
                </div>
                <div class="relative mt-4">
                    <input type="text" placeholder="Workouts, Trainers, Music, and More" class="w-full bg-[#1c1c1e] text-white placeholder-gray-400 rounded-lg py-2 pl-10 pr-4 border-none focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </header>

            <main class="flex-grow p-4 overflow-y-auto no-scrollbar main-content-padding">
                <div id="week-navigation" class="flex items-center justify-between mb-4">
                     <button id="prev-week-btn" class="p-2 rounded-full hover:bg-gray-800 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                     <h2 id="week-title" class="text-xl font-bold"></h2>
                     <button id="next-week-btn" class="p-2 rounded-full hover:bg-gray-800 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></button>
                </div>
                <h3 class="text-2xl font-bold mb-3">Activity Types</h3>
                <div id="activity-cards" class="grid grid-cols-2 gap-4">
                    <!-- Kartu aktivitas akan di-generate oleh JS -->
                </div>
                 <div class="mt-8">
                    <h3 class="text-2xl font-bold mb-3">Settings</h3>
                    <div class="space-y-3">
                        <button id="add-week-btn" class="w-full text-left flex items-center gap-4 bg-[#1c1c1e] p-4 rounded-xl hover:bg-gray-800 transition-colors">
                            <div class="bg-green-500 p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg></div>
                            <span class="font-semibold">Add New Week</span>
                        </button>
                         <button id="manage-templates-btn" class="w-full text-left flex items-center gap-4 bg-[#1c1c1e] p-4 rounded-xl hover:bg-gray-800 transition-colors">
                            <div class="bg-blue-500 p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1z"/><path d="M4 5.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5z"/></svg></div>
                            <span class="font-semibold">Manage Templates</span>
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <!-- Halaman Detail Latihan -->
        <!-- FIXED: Menambahkan `min-h-0` yang penting untuk flexbox scrolling -->
        <div id="workout-detail-view" class="hidden flex flex-col flex-grow min-h-0">
            <!-- Konten akan digenerate oleh JS -->
        </div>

        <!-- Navigasi Bawah -->
        <nav id="bottom-nav" class="fixed bottom-0 left-1/2 w-full max-w-lg bg-black/70 backdrop-blur-lg border-t border-gray-700 z-20 bottom-nav">
            <div class="flex justify-around items-center h-[70px]">
                <button data-target="summary-modal" class="bottom-nav-btn flex flex-col items-center gap-1 text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m18.7 8-5.1 5.2-2.8-2.7L7 15.2"/></svg>
                    <span class="text-xs font-medium">Summary</span>
                </button>
                <button data-target="main-view" class="bottom-nav-btn flex flex-col items-center gap-1 text-purple-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4" fill="none" stroke="black" stroke-width="2"></path></svg>
                    <span class="text-xs font-bold">Fitness+</span>
                </button>
                <button data-target="gallery-modal" class="bottom-nav-btn flex flex-col items-center gap-1 text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    <span class="text-xs font-medium">Gallery</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Berbagai Modal -->
    <div id="modals">
        <!-- Modal Timer -->
        <div id="timer-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 hidden">
            <div id="timer-modal-content" class="bg-[#1c1c1e] rounded-2xl p-6 w-full max-w-sm text-center shadow-lg modal-enter">
                <h2 class="text-xl font-bold mb-2 text-purple-400">Start Timer</h2>
                <p id="timer-exercise-name" class="text-gray-300 mb-6">Select rest duration.</p>
                <div id="duration-selection">
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <button onclick="app.startCountdown(30)" class="bg-gray-700 hover:bg-purple-500 transition-colors duration-200 rounded-lg py-3 font-semibold">30s</button>
                        <button onclick="app.startCountdown(60)" class="bg-gray-700 hover:bg-purple-500 transition-colors duration-200 rounded-lg py-3 font-semibold">60s</button>
                        <button onclick="app.startCountdown(90)" class="bg-gray-700 hover:bg-purple-500 transition-colors duration-200 rounded-lg py-3 font-semibold">90s</button>
                    </div>
                    <button onclick="app.closeModal('timer-modal')" class="w-full bg-gray-600 hover:bg-gray-500 transition-colors duration-200 rounded-lg py-2 font-medium">Cancel</button>
                </div>
                <div id="countdown-display" class="hidden">
                    <div id="countdown-timer" class="text-7xl font-bold text-purple-400 my-6">00:00</div>
                    <button id="finish-button" onclick="app.finishTimer()" class="w-full bg-purple-600 hover:bg-purple-500 transition-colors duration-200 rounded-lg py-3 font-bold text-lg hidden">FINISH</button>
                    <p id="countdown-message" class="text-gray-400 mt-2">Rest time...</p>
                </div>
            </div>
        </div>
        
        <!-- Modal Summary Mingguan -->
        <div id="summary-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-[#1c1c1e] rounded-2xl p-6 w-full max-w-md text-center shadow-lg modal-enter">
                <h2 class="text-xl font-bold mb-4 text-purple-400">Weekly Summary</h2>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <canvas id="weekly-chart"></canvas>
                </div>
                <div id="summary-stats" class="text-left mt-4 space-y-1 text-sm"></div>
                <button onclick="app.closeModal('summary-modal')" class="mt-6 w-full bg-gray-600 hover:bg-gray-500 transition-colors duration-200 rounded-lg py-2 font-medium">Close</button>
            </div>
        </div>

        <!-- Modal Galeri Selfie -->
        <div id="gallery-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-[#1c1c1e] rounded-2xl p-6 w-full max-w-sm text-center shadow-lg modal-enter">
                <h2 class="text-xl font-bold mb-4 text-purple-400">Transformation Gallery</h2>
                <div id="gallery-content" class="max-h-96 overflow-y-auto space-y-4 no-scrollbar"></div>
                <button onclick="app.closeModal('gallery-modal')" class="mt-6 w-full bg-gray-600 hover:bg-gray-500 transition-colors duration-200 rounded-lg py-2 font-medium">Close</button>
            </div>
        </div>

        <!-- Modal Pilih Template -->
        <div id="template-select-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-[#1c1c1e] rounded-2xl p-6 w-full max-w-sm text-center shadow-lg modal-enter">
                <h2 class="text-xl font-bold mb-4 text-purple-400">Start New Week</h2>
                <p class="text-gray-400 mb-4">Choose a program for this week.</p>
                <div id="template-options" class="space-y-2"></div>
                <button onclick="app.closeModal('template-select-modal')" class="mt-4 w-full bg-gray-600 hover:bg-gray-500 transition-colors duration-200 rounded-lg py-2 font-medium">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Motivasi -->
    <div id="motivational-toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 w-11/12 max-w-sm bg-purple-500 text-white p-4 rounded-xl shadow-2xl z-50 pointer-events-none hidden">
        <p class="text-center font-bold"></p>
    </div>

    <!-- Area Rendering & Editor (di luar layar) -->
    <div id="offscreen-elements" class="fixed -left-[9999px] top-0">
        <div id="snapshot-wrapper" class="p-8 bg-black">
            <div id="snapshot-content" class="snapshot-container bg-[#1c1c1e] text-white p-8 flex flex-col rounded-3xl border-4 border-purple-500 shadow-2xl">
                <header class="text-center mb-6"><h2 id="snapshot-title" class="text-3xl font-bold"></h2><p id="snapshot-date" class="text-gray-400"></p></header>
                <main id="snapshot-list" class="flex-grow space-y-3 overflow-y-auto no-scrollbar"></main>
                <footer class="text-center mt-6 pt-4 border-t border-gray-600"><p class="font-bold text-xl text-purple-400">FWorkout+</p></footer>
            </div>
        </div>
        <canvas id="image-resizer-canvas"></canvas>
    </div>
    
    <!-- Editor Template (halaman terpisah) -->
    <div id="template-editor-page" class="hidden fixed inset-0 bg-black z-[100] p-4 flex-col">
        <!-- Konten editor akan di-generate oleh JS -->
    </div>

    <script>
    const App = function() {
        // --- DATA LATIHAN DEFAULT, QUOTES & STYLING ---
        this.initialWeekSchedule = {
            1: { name: "Push â€” Chest, Shoulders, Triceps", exercises: [ { name: "Dumbbell Chest Press", sets: "4x12" }, { name: "Push-Up", sets: "3xMax" }, { name: "Overhead Dumbbell Press", sets: "4x10" }, { name: "Dumbbell Front Raise", sets: "3x12" }, { name: "Dumbbell Triceps Kickback", sets: "3x12" }, { name: "Triceps Dips", sets: "3x15" } ] },
            2: { name: "Pull â€” Back, Biceps", exercises: [ { name: "Pull-Up (Wide)", sets: "4xMax" }, { name: "Dumbbell Row", sets: "4x10" }, { name: "Bicep Curl", sets: "4x12" }, { name: "Concentration Curl", sets: "3x10 each" }, { name: "Shrug", sets: "3x15" }, { name: "Face Pull", sets: "3x12" } ] },
            3: { name: "Full Body Dumbbell", exercises: [ { name: "Goblet Squat", sets: "4x15" }, { name: "Dumbbell Clean & Press", sets: "3x10" }, { name: "Dumbbell Deadlift", sets: "4x8" }, { name: "Lateral Raise", sets: "3x15" }, { name: "Russian Twist", sets: "3x20" } ] },
            4: { name: "Legs & Core", exercises: [ { name: "Squats", sets: "4x12" }, { name: "Lunges", sets: "3x10 each" }, { name: "Hanging Leg Raise", sets: "4x15" }, { name: "Plank", sets: "3x45s" }, { name: "Side Plank", sets: "2x30s each" }, { name: "Supermans", sets: "3x20" } ] },
            5: { name: "HIIT", exercises: [ { name: "Burpees", sets: "4x10" }, { name: "High Knees", sets: "3x30s" }, { name: "Jumping Jacks", sets: "3x45s" }, { name: "Mountain Climbers", sets: "3x30s" }, { name: "Incline Push-Up", sets: "3x15" }, { name: "Jump Squats", sets: "3x12" } ] },
            6: { name: "Mobility & Light Core", exercises: [ { name: "Shoulder Mobility", sets: "5 min" }, { name: "Hip Opener", sets: "5 min" }, { name: "Bird Dog", sets: "3x15/side" }, { name: "Leg Raises", sets: "3x15" }, { name: "Crunches", sets: "3x20" } ] },
            0: { name: "Rest Day & Progress Photo", exercises: [ { name: "Rest, hydrate, and fuel your body for the week ahead.", sets: "âœ…" } ] }
        };
        this.motivationalQuotes = [ "Progress, not perfection ðŸ’ª", "Consistency beats motivation ðŸš€", "One set today is better than zero sets yesterday.", "Today's sweat = tomorrow's strength ðŸ”¥", "Youâ€™re stronger than you think.", "Don't stop when you're tired. Stop when you're done.", "The only bad workout is the one that didn't happen." ];
        this.dayStyles = {
            "Push": { color: "from-red-500 to-orange-500", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>` },
            "Pull": { color: "from-purple-500 to-indigo-500", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>` },
            "Full Body": { color: "from-green-400 to-cyan-400", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0L12 2.69z"></path></svg>` },
            "Legs": { color: "from-blue-500 to-sky-500", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 22l-4-4 1.5-1.5M18 22l4-4-1.5-1.5M12 17V3M3 3h18"/></svg>` },
            "HIIT": { color: "from-yellow-400 to-amber-500", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>` },
            "Mobility": { color: "from-teal-400 to-emerald-500", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>` },
            "Rest": { color: "from-gray-600 to-gray-700", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>` },
        };
        this.tingSound = new Audio('data:audio/wav;base64,UklGRjIAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YSgAAACAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC-');

        // --- STATE APLIKASI ---
        this.appData = { weeks: [], templates: [], settings: {} };
        this.currentWeekIndex = 0;
        this.currentView = 'main-view';
        this.timerInterval;
        this.activeTimerInfo = {};
        this.weeklyChartInstance = null;
        this.dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        this.lastScrollY = 0;

        // --- ELEMEN DOM ---
        this.dom = {
            mainView: document.getElementById('main-view'),
            workoutDetailView: document.getElementById('workout-detail-view'),
            activityCards: document.getElementById('activity-cards'),
            weekTitle: document.getElementById('week-title'),
            prevWeekBtn: document.getElementById('prev-week-btn'),
            nextWeekBtn: document.getElementById('next-week-btn'),
            addWeekBtn: document.getElementById('add-week-btn'),
            manageTemplatesBtn: document.getElementById('manage-templates-btn'),
            bottomNav: document.getElementById('bottom-nav'),
            bottomNavBtns: document.querySelectorAll('.bottom-nav-btn'),
            timerModalEl: document.getElementById('timer-modal'),
            timerExerciseNameEl: document.getElementById('timer-exercise-name'),
            durationSelectionEl: document.getElementById('duration-selection'),
            countdownDisplayEl: document.getElementById('countdown-display'),
            countdownTimerEl: document.getElementById('countdown-timer'),
            finishButtonEl: document.getElementById('finish-button'),
            countdownMessageEl: document.getElementById('countdown-message'),
            motivationalToastEl: document.getElementById('motivational-toast'),
            summaryModalEl: document.getElementById('summary-modal'),
            weeklyChartCanvas: document.getElementById('weekly-chart').getContext('2d'),
            summaryStatsEl: document.getElementById('summary-stats'),
            galleryModalEl: document.getElementById('gallery-modal'),
            galleryContentEl: document.getElementById('gallery-content'),
            templateSelectModalEl: document.getElementById('template-select-modal'),
            templateOptionsEl: document.getElementById('template-options'),
            snapshot: { content: document.getElementById('snapshot-content'), title: document.getElementById('snapshot-title'), date: document.getElementById('snapshot-date'), list: document.getElementById('snapshot-list') },
            imageResizerCanvas: document.getElementById('image-resizer-canvas'),
            templateEditorPageEl: document.getElementById('template-editor-page'),
        };

        // --- INIT & EVENT LISTENERS ---
        this.init = () => {
            this.loadData();
            this.renderMainView();
            this.addEventListeners();
            this.showMotivationalQuote();
            this.requestNotificationPermission();
        };
        
        this.addEventListeners = () => {
            this.dom.mainView.querySelector('main').addEventListener('scroll', this.handleScroll);
            this.dom.timerModalEl.addEventListener('click', (e) => e.target === this.dom.timerModalEl && this.closeModal('timer-modal'));
            this.dom.prevWeekBtn.addEventListener('click', () => this.changeWeek(this.currentWeekIndex - 1));
            this.dom.nextWeekBtn.addEventListener('click', () => this.changeWeek(this.currentWeekIndex + 1));
            this.dom.addWeekBtn.addEventListener('click', this.addNewWeek);
            this.dom.manageTemplatesBtn.addEventListener('click', () => this.showTemplateEditor());
            this.dom.bottomNavBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.dataset.target;
                    if (targetId.endsWith('-modal')) {
                        if (targetId === 'summary-modal') this.renderWeeklyChart();
                        if (targetId === 'gallery-modal') this.renderSelfieGallery();
                    } else {
                        this.switchView(targetId);
                    }
                });
            });
        };
        
        // --- FUNGSI SCROLL ---
        this.handleScroll = (e) => {
            const currentScrollY = e.target.scrollTop;
            const nav = this.dom.bottomNav;
            if (currentScrollY > this.lastScrollY && currentScrollY > 50) {
                nav.classList.add('nav-hidden');
            } else if (currentScrollY < this.lastScrollY) {
                nav.classList.remove('nav-hidden');
            }
            this.lastScrollY = currentScrollY <= 0 ? 0 : currentScrollY;
        };

        // --- FUNGSI-FUNGSI VIEW & RENDER ---
        this.switchView = (viewId, dayIndex = null) => {
            const currentViewEl = document.getElementById(this.currentView);
            const nextViewEl = document.getElementById(viewId);
            if (!nextViewEl || this.currentView === viewId) return;

            // Reset scroll tracking and ensure nav is visible when changing views
            this.lastScrollY = 0;
            this.dom.bottomNav.classList.remove('nav-hidden');

            currentViewEl.classList.add('view-leave-active');
            setTimeout(() => {
                currentViewEl.classList.add('hidden');
                currentViewEl.classList.remove('view-leave-active');
                if (viewId === 'workout-detail-view') {
                    this.renderWorkoutDetailView(dayIndex);
                } else {
                    this.renderMainView();
                }
                nextViewEl.classList.remove('hidden');
                nextViewEl.classList.add('view-enter');
                this.currentView = viewId;
                requestAnimationFrame(() => {
                    nextViewEl.classList.add('view-enter-active');
                });
            }, 150);
             setTimeout(() => nextViewEl.classList.remove('view-enter', 'view-enter-active'), 450);
        };

        this.renderMainView = () => {
            const weekData = this.appData.weeks[this.currentWeekIndex];
            if (!weekData) return;
            this.dom.weekTitle.textContent = weekData.name;
            this.dom.activityCards.innerHTML = Object.keys(weekData.schedule).map(dayKey => {
                const dayData = weekData.schedule[dayKey];
                const dayName = this.dayNames[dayKey];
                const styleKey = Object.keys(this.dayStyles).find(k => dayData.name.toLowerCase().includes(k.toLowerCase())) || "Rest";
                const style = this.dayStyles[styleKey];
                const totalSets = dayData.exercises.reduce((acc, ex) => acc + this.parseSets(ex.sets), 0);
                const completedSets = dayData.exercises.reduce((acc, ex) => acc + (ex.completed ? ex.completed.filter(Boolean).length : 0), 0);
                const isCompleted = totalSets > 0 && completedSets === totalSets;
                return `
                    <div class="relative rounded-2xl overflow-hidden shadow-lg transform hover:scale-105 transition-transform duration-300" onclick="app.switchView('workout-detail-view', ${dayKey})">
                        <div class="absolute inset-0 bg-gradient-to-br ${style.color}"></div>
                        <div class="relative p-4 h-40 flex flex-col justify-between text-white">
                            <div>
                                <h4 class="font-bold text-lg leading-tight">${dayName}</h4>
                                <p class="text-sm opacity-80">${dayData.name.split('â€”')[0]}</p>
                            </div>
                            <div class="self-end">
                                ${isCompleted ? `<div class="w-8 h-8 rounded-full bg-black/30 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div>` : style.icon}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        };

        this.renderWorkoutDetailView = (dayIndex) => {
            const weekData = this.appData.weeks[this.currentWeekIndex];
            const dayData = weekData.schedule[dayIndex];
            const isRestDay = parseInt(dayIndex) === 0;
            let contentHTML = `
                <header class="p-4 flex items-center flex-shrink-0">
                    <button onclick="app.switchView('main-view')" class="p-2 -ml-2 mr-2 rounded-full hover:bg-gray-800"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                    <h2 class="text-2xl font-bold">${this.dayNames[dayIndex]}</h2>
                    <button onclick="app.generateStoryImage(${dayIndex})" title="Share Progress" class="p-2 ml-auto rounded-full hover:bg-gray-800"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg></button>
                </header>
                <main id="workout-list" class="flex-grow p-4 space-y-3 overflow-y-auto no-scrollbar main-content-padding">
            `;
            if (isRestDay) {
                const selfieHTML = `
                    <div class="mt-4">
                        <label for="selfie-upload-${this.currentWeekIndex}" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2 text-lg cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1zm9 2.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0z"/></svg>
                            Upload Progress Photo
                        </label>
                        <input type="file" id="selfie-upload-${this.currentWeekIndex}" class="hidden" accept="image/*" onchange="app.handlePhotoUpload(event, ${this.currentWeekIndex})">
                    </div>`;
                contentHTML += `<div class="bg-[#1c1c1e] rounded-2xl p-6 text-center shadow-lg"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400 mb-4 mx-auto"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg><h2 class="text-xl font-bold">${dayData.name}</h2><p class="text-gray-400">${dayData.exercises[0].name}</p>${selfieHTML}</div>`;
            } else {
                 contentHTML += dayData.exercises.map((ex, exIdx) => {
                    const totalSets = this.parseSets(ex.sets);
                    return `<div class="bg-[#1c1c1e] rounded-2xl p-4 shadow-lg"><div class="flex justify-between items-start"><h3 class="font-bold text-lg text-white">${ex.name}</h3><p class="text-sm font-medium text-purple-400 bg-gray-700 px-2 py-1 rounded-md">${ex.sets}</p></div><div class="space-y-2 mt-3">${Array.from({ length: totalSets }).map((_, setIdx) => `<div class="flex items-center justify-between bg-gray-800 rounded-lg p-2"><div class="flex items-center"><input type="checkbox" id="check-${this.currentWeekIndex}-${dayIndex}-${exIdx}-${setIdx}" class="hidden" onchange="app.toggleSet(${dayIndex}, ${exIdx}, ${setIdx})" ${ex.completed[setIdx] ? 'checked' : ''}><label for="check-${this.currentWeekIndex}-${dayIndex}-${exIdx}-${setIdx}" class="flex items-center cursor-pointer"><span class="w-6 h-6 rounded-md border-2 ${ex.completed[setIdx] ? 'bg-purple-500 border-purple-500' : 'border-gray-500'} flex items-center justify-center mr-3 transition-all duration-200">${ex.completed[setIdx] ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>' : ''}</span><span class="font-medium text-gray-200">Set ${setIdx + 1}</span></label></div><button onclick="app.openTimerModal(${dayIndex}, ${exIdx}, ${setIdx})" class="flex items-center gap-1 bg-gray-600 hover:bg-purple-600 text-white font-semibold px-3 py-1 rounded-md text-sm transition-colors duration-200" ${ex.completed[setIdx] ? 'disabled' : ''}><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> Timer</button></div>`).join('')}</div></div>`
                }).join('');
            }
            contentHTML += `</main>`;
            this.dom.workoutDetailView.innerHTML = contentHTML;
            this.dom.workoutDetailView.querySelector('main').addEventListener('scroll', this.handleScroll);
        };

        this.parseSets = (setsString) => {
            if (typeof setsString !== 'string') return 1;
            const match = setsString.match(/^(\d+)/);
            return match ? parseInt(match[1], 10) : 1;
        };

        this.toggleSet = (dayIndex, exIdx, setIdx) => { 
            const isChecked = document.getElementById(`check-${this.currentWeekIndex}-${dayIndex}-${exIdx}-${setIdx}`).checked; 
            this.appData.weeks[this.currentWeekIndex].schedule[dayIndex].exercises[exIdx].completed[setIdx] = isChecked; 
            this.saveData(); 
            this.renderWorkoutDetailView(dayIndex); 
        };

        // --- FUNGSI PEKAN (WEEK) & TEMPLATE ---
        this.changeWeek = (weekIndex) => { 
            if (weekIndex < 0 || weekIndex >= this.appData.weeks.length) return;
            this.currentWeekIndex = weekIndex; 
            this.renderMainView();
            this.saveData(); 
        };
        this.addNewWeek = () => { this.renderTemplateSelection(); this.openModal('template-select-modal'); };
        this.renderTemplateSelection = () => {
            const templates = [{ name: "Default Program" }, ...this.appData.templates];
            this.dom.templateOptionsEl.innerHTML = templates.map((t, i) => `<button class="w-full text-left bg-gray-700 hover:bg-purple-500 p-3 rounded-lg" onclick='app.commitNewWeek(${i === 0 ? null : JSON.stringify(t)})'>${t.name}</button>`).join('');
        };
        this.commitNewWeek = (template) => {
            const newWeekNumber = this.appData.weeks.length + 1;
            const newWeekName = template ? `${template.name} - Week ${newWeekNumber}` : `Week ${newWeekNumber}`;
            const schedule = template ? template.schedule : this.initialWeekSchedule;
            const newWeek = this.createWeekData(newWeekName, schedule);
            this.appData.weeks.push(newWeek);
            this.currentWeekIndex = this.appData.weeks.length - 1;
            this.saveData();
            this.renderMainView();
            this.closeModal('template-select-modal');
        };

        // --- FUNGSI TIMER ---
        this.openTimerModal = (dayIndex, exIdx, setIdx) => { this.activeTimerInfo = { dayIndex, exIdx, setIdx }; const exName = this.appData.weeks[this.currentWeekIndex].schedule[dayIndex].exercises[exIdx].name; this.dom.timerExerciseNameEl.textContent = `Rest after: ${exName} - Set ${setIdx + 1}`; this.dom.durationSelectionEl.style.display = 'block'; this.dom.countdownDisplayEl.style.display = 'none'; this.dom.finishButtonEl.style.display = 'none'; this.dom.countdownMessageEl.textContent = 'Rest time...'; this.openModal('timer-modal'); };
        this.startCountdown = (duration) => { this.dom.durationSelectionEl.style.display = 'none'; this.dom.countdownDisplayEl.style.display = 'block'; let timer = duration; const updateDisplay = () => { const minutes = Math.floor(timer / 60).toString().padStart(2, '0'); const seconds = (timer % 60).toString().padStart(2, '0'); this.dom.countdownTimerEl.textContent = `${minutes}:${seconds}`; }; updateDisplay(); this.timerInterval = setInterval(() => { timer--; updateDisplay(); if (timer < 0) { clearInterval(this.timerInterval); this.dom.countdownMessageEl.textContent = 'Time\'s up!'; this.dom.finishButtonEl.style.display = 'block'; try { this.tingSound.play(); } catch(e) {} } }, 1000); };
        this.finishTimer = () => { const { dayIndex, exIdx, setIdx } = this.activeTimerInfo; this.appData.weeks[this.currentWeekIndex].schedule[dayIndex].exercises[exIdx].completed[setIdx] = true; this.saveData(); this.renderWorkoutDetailView(dayIndex); this.closeModal('timer-modal'); };

        // --- FITUR LAINNYA ---
        this.showMotivationalQuote = () => {
            const today = new Date().toDateString();
            if (this.appData.settings.lastQuoteDate === today) return;
            const quote = this.motivationalQuotes[Math.floor(Math.random() * this.motivationalQuotes.length)];
            const toast = this.dom.motivationalToastEl;
            toast.querySelector('p').textContent = quote;
            toast.classList.remove('hidden');
            toast.classList.add('toast-enter', 'toast-enter-active');
            setTimeout(() => {
                toast.classList.remove('toast-enter-active');
                toast.classList.add('toast-leave-active');
                setTimeout(() => {
                    toast.classList.add('hidden');
                    toast.classList.remove('toast-enter', 'toast-leave-active');
                }, 500);
            }, 3000);
            this.appData.settings.lastQuoteDate = today;
            this.saveData();
        };

        this.renderWeeklyChart = () => {
            const weekData = this.appData.weeks[this.currentWeekIndex];
            if (!weekData) return;
            const setsPerDay = this.dayNames.map((_, dayIndex) => {
                if (!weekData.schedule[dayIndex] || !weekData.schedule[dayIndex].exercises) return 0;
                return weekData.schedule[dayIndex].exercises.reduce((total, ex) => total + ex.completed.filter(Boolean).length, 0);
            }).slice(1);
            const totalSets = setsPerDay.reduce((a, b) => a + b, 0);
            const maxSets = Math.max(...setsPerDay);
            const bestDayIndex = setsPerDay.indexOf(maxSets);
            const bestDay = totalSets > 0 ? this.dayNames[bestDayIndex + 1] : 'None yet';
            this.dom.summaryStatsEl.innerHTML = `<p><strong>Total Sets Completed:</strong> <span class="font-bold text-purple-400">${totalSets}</span></p><p><strong>Most Active Day:</strong> <span class="font-bold text-purple-400">${bestDay}</span></p>`;
            if (this.weeklyChartInstance) this.weeklyChartInstance.destroy();
            this.weeklyChartInstance = new Chart(this.dom.weeklyChartCanvas, {
                type: 'bar',
                data: { labels: this.dayNames.slice(1), datasets: [{ label: 'Sets Completed', data: setsPerDay, backgroundColor: 'rgba(192, 132, 252, 0.7)', borderColor: 'rgba(192, 132, 252, 1)', borderWidth: 1, borderRadius: 4, }] },
                options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#9ca3af', stepSize: 1 }, grid: { color: '#4b5563' } }, y: { ticks: { color: '#d1d5db' }, grid: { color: '#4b5563' } } } }
            });
            this.openModal('summary-modal');
        };

        this.handlePhotoUpload = (event, weekIndex) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = this.dom.imageResizerCanvas;
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 600;
                    const scale = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    this.appData.weeks[weekIndex].selfie = dataUrl;
                    this.saveData();
                    alert('Photo saved successfully!');
                    this.renderWorkoutDetailView(0); // Refresh rest day view
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        this.renderSelfieGallery = () => {
            this.dom.galleryContentEl.innerHTML = '';
            const weeksWithSelfies = this.appData.weeks.filter(w => w.selfie);
            if (weeksWithSelfies.length === 0) {
                this.dom.galleryContentEl.innerHTML = '<p class="text-gray-400">No photos uploaded yet. Upload your weekly progress photo on Rest Day!</p>';
            } else {
                weeksWithSelfies.forEach(week => {
                    this.dom.galleryContentEl.innerHTML += `<div class="relative"><img src="${week.selfie}" class="rounded-lg w-full"><p class="absolute bottom-2 left-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded">${week.name}</p></div>`;
                });
            }
            this.openModal('gallery-modal');
        };

        this.showTemplateEditor = () => { /* ... (fungsi editor template tidak diubah) ... */ };
        this.hideTemplateEditor = () => { /* ... (fungsi editor template tidak diubah) ... */ };
        this.requestNotificationPermission = async () => { /* ... (fungsi notifikasi tidak diubah) ... */ };
        this.showDailyReminderNotification = () => { /* ... (fungsi notifikasi tidak diubah) ... */ };

        this.generateStoryImage = (dayIndex) => {
            const weekData = this.appData.weeks[this.currentWeekIndex];
            const dayData = weekData.schedule[dayIndex];
            this.dom.snapshot.title.textContent = `Progress ${this.dayNames[dayIndex]} âœ…`;
            this.dom.snapshot.date.textContent = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
            this.dom.snapshot.list.innerHTML = dayData.exercises.map(ex => { const totalSets = this.parseSets(ex.sets); const completedCount = ex.completed.filter(Boolean).length; return `<div class="bg-gray-700 p-3 rounded-lg flex justify-between items-center"><span class="font-medium">${ex.name}</span><span class="font-bold text-purple-400">${completedCount}/${totalSets}</span></div>` }).join('');
            html2canvas(this.dom.snapshot.content, { useCORS: true, scale: 2, backgroundColor: null }).then(canvas => { const link = document.createElement('a'); link.download = `FWorkout_Progress_${this.dayNames[dayIndex]}_${weekData.name.replace(/\s/g, '')}.png`; link.href = canvas.toDataURL('image/png'); link.click(); }).catch(err => { console.error("Oops, something went wrong!", err); alert("Failed to create image."); });
        };
        
        // --- PENYIMPANAN DATA ---
        this.createWeekData = (name, schedule) => {
            const newSchedule = JSON.parse(JSON.stringify(schedule));
            Object.values(newSchedule).forEach(day => { if(day.exercises) day.exercises.forEach(ex => { ex.completed = Array(this.parseSets(ex.sets)).fill(false); }); });
            return { name, schedule: newSchedule, selfie: null };
        };
        this.saveData = () => { localStorage.setItem('fworkout_data_v3', JSON.stringify(this.appData)); };
        this.loadData = () => {
            const savedData = localStorage.getItem('fworkout_data_v3');
            if (savedData) {
                const parsed = JSON.parse(savedData);
                this.appData = { weeks: parsed.weeks || [], templates: parsed.templates || [], settings: parsed.settings || {}, };
                this.currentWeekIndex = parsed.currentWeekIndex || 0;
            }
            if (this.appData.weeks.length === 0) {
                this.appData.weeks.push(this.createWeekData("Week 1", this.initialWeekSchedule));
                this.currentWeekIndex = 0;
            }
            this.saveData();
        };
        
        // --- HELPER MODAL ---
        this.openModal = (id) => { const el = document.getElementById(id); if(el) { el.classList.remove('hidden'); setTimeout(() => el.querySelector('.modal-enter')?.classList.add('modal-enter-active'), 10); } };
        this.closeModal = (id) => { const el = document.getElementById(id); if(el) { el.querySelector('.modal-enter')?.classList.remove('modal-enter-active'); el.querySelector('.modal-enter')?.classList.add('modal-leave-active'); setTimeout(() => { el.classList.add('hidden'); el.querySelector('.modal-enter')?.classList.remove('modal-leave-active'); }, 200); } };
    };

    const app = new App();
    document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
